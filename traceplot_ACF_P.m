function traceplot_ACF_P(PSnor,nrow,ncol_even)%--------------------------------------------% function name: traceplot_ACF_P%% Produce trace plots and ACF plots along with ESS for elements of % source composition matrix (P)%% Usage example:% traceplot_ACF_P(PSnor);% traceplot_ACF_P(PSnor,nrow,ncol_even);%% Input:% PSnor: Stored MCMC samples for P (q by J by nsample)% nrow (optional): number of plots to display in one column per windo% <--Default: nrow=3% ncol_even (optional): number of plots to display in one row per window. % Use an even number for ncol_even. (Either 2 or 4 is the best.)% <--Default: ncol_even=4%% Eun Sug Park, August 2020% Last updated February 2021%----------------------------------------[q,J,nsample]=size(PSnor);vecPSfree=reshape(PSnor,q*J,nsample)';zeroindexP=find(PSnor(:,:,1)==0);vecPSfree(:,zeroindexP)=[]; %Stored samples for free elements of P [nsample,s]=size(vecPSfree); %s: number of free elements of P%vnamesP: string vector of variable names for elements of P (stacked column-wise)vnamesP=strings(q*J,1);ii=0;for j=1:J   for i=1:q     ii=ii+1;     vnamesP(ii)= ['P[', num2str(i), ',', num2str(j), ']'];   endendvnamesP(zeroindexP)=[];[nsample,s]=size(vecPSfree);n1=29;t=0:n1;ubound=1.96/sqrt(nsample);lbound=-1.96/sqrt(nsample);zmean=mean(vecPSfree);roS=zeros(nsample,s);ESS=zeros(1,s);for j=1:s    z=vecPSfree(:,j);    zmeanj=zmean(j);    ro=zeros(1,nsample-1);    for i=1:n1        ro(i)=((z(1:nsample-i)-zmeanj*ones(nsample-i,1))'*(z(i+1:nsample)-zmeanj*ones(nsample-i,1)))/sum((z-zmeanj*ones(nsample,1)).^2);    end    k=min(find(ro<0.05));    ESS(j)=nsample/(1+2*sum(ro(1:k)));    ro1=[1 ro];    roS(:,j)=ro1';endfigureif nargin==1      nrow=3; ncol_even=4;elseif nargin==2      ncol_even=4;endnplot=nrow*ncol_even;  %total number of plots to display per windownum_plot=min(nplot,s*2);ii=0;for j=[1:2:(num_plot-1)]    ii=ii+1;    subplot(nrow,ncol_even,j)    plot(vecPSfree(:,ii))    axis tight    xlabel('sample #')    ylabel('P')    title(vnamesP(ii));        subplot(nrow,ncol_even,j+1)    hold on    stem(t,roS([1:(n1+1)],ii))    plot(t,ubound*ones(length(t)));    plot(t,0*ones(length(t)));    plot(t,lbound*ones(length(t)));    xlabel('Lag')    ylabel('ACF');    c=round(ESS(ii),2);    title(['ESS=',num2str(c)])     axis tight    hold offend